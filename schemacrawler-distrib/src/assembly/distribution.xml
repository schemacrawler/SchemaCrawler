<!--
 Copyright (c) Sualeh Fatehi
 SPDX-License-Identifier: EPL-2.0
-->

<project xmlns:ivy="antlib:org.apache.ivy.ant"
    name="schemacrawler"
    default="make"
  basedir=".">


  <property name="distribution.target"
    location="${SchemaCrawler.home}/schemacrawler-distrib/target" />
  <property
    name="schemacrawler.expanded-distribution"
    value="${distribution.target}/_expanded-distribution" />


  <target name="make"
    depends="
            make-expanded-distribution,
            make-binary-distribution-zip
          "
    description="Package SchemaCrawler distributable" />



  <target name="make-expanded-distribution">

    <echo message="Running ant target: make-expanded-distribution" />

    <property
        name="distribution.assembly"
      location="${SchemaCrawler.home}/schemacrawler-distrib/src/assembly" />

    <mkdir dir="${schemacrawler.expanded-distribution}/bin" />
    <copy todir="${schemacrawler.expanded-distribution}/bin">
      <fileset dir="${distribution.assembly}">
        <include name="schemacrawler.cmd" />
        <include name="schemacrawler.sh" />
      </fileset>
    </copy>
    <copy todir="${schemacrawler.expanded-distribution}/bin">
      <fileset dir="${schemacrawler.expanded-distribution}/bin">
        <include name="schemacrawler.cmd"/>
      </fileset>
      <globmapper from="schemacrawler.cmd" to="schemacrawler.bat"/>
    </copy>

    <copy
        file="${SchemaCrawler.home}/schemacrawler/target/schemacrawler-${SchemaCrawler.version}.jar"
        todir="${schemacrawler.expanded-distribution}/lib" />
    <copy
      file="${SchemaCrawler.home}/schemacrawler-docs/config/schemacrawler.config.properties"
      todir="${schemacrawler.expanded-distribution}/config" />
    <copy
      file="${SchemaCrawler.home}/schemacrawler-docs/config/schemacrawler.colormap.properties"
      todir="${schemacrawler.expanded-distribution}/config" />
    <fixcrlf
      srcdir="${schemacrawler.expanded-distribution}/config"
      includes="*.properties"
      eol="lf"
      eof="remove"/>

    <copy todir="${schemacrawler.expanded-distribution}/logos">
      <fileset dir="${SchemaCrawler.home}/schemacrawler-website/src/site/resources/images">
        <include name="schemacrawler_logo.*" />
        <include name="schemacrawler_banner.*" />
      </fileset>
    </copy>

    <copy todir="${schemacrawler.expanded-distribution}"
      flatten="true"
      overwrite="true">
      <fileset dir="${SchemaCrawler.home}/schemacrawler-scripting">
        <include name="**/mermaid.py" />
        <include name="**/dbml.py" />
        <include name="**/plantuml.py" />
        <include name="**/markdown.py" />
      </fileset>
    </copy>
    <fixcrlf
      srcdir="${schemacrawler.expanded-distribution}"
      includes="*.py"
      eol="lf"
      eof="remove"/>

    <!-- Create SQLite test database -->
    <java classname="schemacrawler.testdb.TestSchemaCreatorMain"
      failonerror="true">
      <arg value="--url" />
      <arg value="jdbc:sqlite:${schemacrawler.expanded-distribution}/sc.db" />
      <classpath>
        <fileset dir="${SchemaCrawler.home}/schemacrawler-testdb/target">
          <include name="schemacrawler-testdb-${SchemaCrawler.version}.jar" />
        </fileset>
        <fileset dir="${SchemaCrawler.home}/schemacrawler-utility/target">
          <include name="schemacrawler-utility-${SchemaCrawler.version}.jar" />
        </fileset>
        <fileset dir="${schemacrawler.expanded-distribution}/lib">
          <include name="**/*.jar" />
        </fileset>
      </classpath>
    </java>

  </target>


  <target name="make-binary-distribution-zip">

    <echo message="Running ant target: make-binary-distribution-zip" />

    <property name="binary-distribution.staging.dir" location="${distribution.target}/_expanded-distribution" />
    <property name="binary-distribution.stem"
      value="schemacrawler-${SchemaCrawler.version}-bin" />

    <echo>Create zip file for binary distribution</echo>

    <chmod perm="+x" type="file">
      <dirset dir="${binary-distribution.staging.dir}">
        <include name="**/*.sh"/>
      </dirset>
    </chmod>

    <delete file="${distribution.target}/${binary-distribution.stem}.zip" />
    <zip destfile="${distribution.target}/${binary-distribution.stem}.zip">
      <zipfileset dir="${binary-distribution.staging.dir}"
        prefix="${binary-distribution.stem}" defaultexcludes="yes">
        <exclude name="**/*.sh" />
      </zipfileset>
      <zipfileset dir="${binary-distribution.staging.dir}"
        prefix="${binary-distribution.stem}" defaultexcludes="yes"
        filemode="771">
        <include name="**/*.sh" />
      </zipfileset>
    </zip>

    <checksum algorithm="SHA-512"
      file="${distribution.target}/${binary-distribution.stem}.zip" todir="${distribution.target}" />

  </target>

</project>
